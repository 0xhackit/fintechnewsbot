name: Alerts Prepare (every 5 mins)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

concurrency:
  group: fintech-alerts-prepare
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install feedparser requests python-dateutil python-telegram-bot telethon
          fi

      - name: Run main pipeline (fetch + rank)
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
        run: |
          python run.py

      - name: Check auto_approve flag
        id: check_config
        run: |
          AUTO_APPROVE=$(python -c "import json; config = json.load(open('config.json')); print(str(config.get('alerts', {}).get('auto_approve', False)).lower())")
          echo "auto_approve=$AUTO_APPROVE" >> $GITHUB_OUTPUT
          echo "üîß Config: auto_approve=$AUTO_APPROVE"

      - name: Prepare alert drafts
        if: steps.check_config.outputs.auto_approve != 'true'
        run: |
          python scripts/run_alerts.py --mode prepare

      - name: Commit state changes
        if: steps.check_config.outputs.auto_approve != 'true'
        run: |
          git config user.name "fintech-news-bot"
          git config user.email "fintech-news-bot@users.noreply.github.com"
          git add state/seen_alerts.json out/items_last24h.json out/alerts_drafts.json || true
          git diff --cached --quiet && echo "No state changes" && exit 0
          git commit -m "chore: update alerts state"
          git push

      - name: Create approval issues
        if: steps.check_config.outputs.auto_approve != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'out/alerts_drafts.json';
            if (!fs.existsSync(path)) { console.log("No drafts file."); return; }
            const drafts = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!drafts.length) { console.log("0 drafts"); return; }

            const { owner, repo } = context.repo;
            const existing = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            const existingTitles = new Set(existing.data.map(i => i.title));

            for (const d of drafts) {
              const title = `APPROVAL: ${d.title}`.slice(0, 240);
              if (existingTitles.has(title)) continue;

              const body =
                `### Draft (one story)\n\n` +
                `**Headline:** ${d.title}\n\n` +
                `**Link:** ${d.link}\n\n` +
                `**Telegram draft (HTML):**\n\n` +
                `\`\`\`html\n${d.message_html}\n\`\`\`\n\n` +
                `---\n` +
                `Approve: add label \`approve\`\n` +
                `Reject: add label \`reject\`\n`;

              await github.rest.issues.create({ owner, repo, title, body, labels: ['pending'] });
            }

      - name: Skip message
        if: steps.check_config.outputs.auto_approve == 'true'
        run: |
          echo "‚è≠Ô∏è  Auto-approve is enabled in config.json - skipping manual approval workflow"
          echo "üí° Alerts will be auto-published by the alerts_auto_publish.yml workflow"