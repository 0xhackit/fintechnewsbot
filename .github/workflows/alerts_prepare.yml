name: Alerts Prepare (every 5 mins)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

concurrency:
  group: fintech-alerts-prepare
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install feedparser requests python-dateutil python-telegram-bot telethon
          fi

      - name: Run alerts (prepare drafts)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
        run: |
          python scripts/run_alerts.py --mode prepare

      
      # ðŸ”¥ TEMP TEST STEP (remove after first success)
      - name: force one draft
      
        working-directory: .
        run: |
          mkdir -p out
          cat > out/alerts_drafts.json << 'JSON'
          [
            {
              "id": "test-issue-1",
              "title": "TEST STORY: Approval system works",
              "link": "https://example.com",
              "message_html": "<b>TEST STORY: Approval system works</b> <a href=\"https://example.com\">LINK</a>"
            }
          ]
          JSON

      - name: Create approval issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'mvp/fintech-news-mvp/out/alerts_drafts.json';
            if (!fs.existsSync(path)) {
              console.log("No drafts file found.");
              return;
            }

            const drafts = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!drafts.length) {
              console.log("No drafts to create.");
              return;
            }

            const { owner, repo } = context.repo;

            const existing = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 100
            });
            const existingTitles = new Set(existing.data.map(i => i.title));

            for (const d of drafts) {
              const title = `APPROVAL: ${d.title}`.slice(0, 240);
              if (existingTitles.has(title)) continue;

              const body =
                `### Draft (one story)\n\n` +
                `**Headline:** ${d.title}\n\n` +
                `**Link:** ${d.link}\n\n` +
                `**Telegram draft (HTML):**\n` +
                `\n\`\`\`html\n${d.message_html}\n\`\`\`\n\n` +
                `---\n` +
                `**Approve:** add label \`approve\`\n` +
                `**Reject:** add label \`reject\`\n\n` +
                `(id: ${d.id})`;

              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ['pending']
              });
            }

      - name: Commit updated state
        working-directory: .
        run: |
          git config user.name "fintech-news-bot"
          git config user.email "fintech-news-bot@users.noreply.github.com"
          git add state/seen_alerts.json || true
          git diff --cached --quiet && echo "No state changes" && exit 0
          git commit -m "chore: update alerts state (prepare)"
          git push