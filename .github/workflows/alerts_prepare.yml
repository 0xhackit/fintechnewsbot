name: Alerts Prepare (every 5 mins)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

concurrency:
  group: fintech-alerts-prepare
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install feedparser requests python-dateutil; fi

      - name: Run alerts (prepare drafts)
        run: |
          python scripts/run_alerts.py --mode prepare

      - name: Create approval issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const path = 'out/alerts_drafts.json';
            if (!fs.existsSync(path)) {
              core.info('No out/alerts_drafts.json found. Nothing to create.');
              return;
            }

            const drafts = JSON.parse(fs.readFileSync(path, 'utf8'));
            if (!drafts.length) {
              core.info('No drafts.');
              return;
            }

            const { owner, repo } = context.repo;

            const existing = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            const existingTitles = new Set(existing.data.map(i => i.title));

            for (const d of drafts) {
              const title = (`APPROVAL: ${d.title}`).slice(0, 240);
              if (existingTitles.has(title)) continue;

              const bodyLines = [
                '### Draft (one story)',
                '',
                `**Headline:** ${d.title}`,
                '',
                `**Link:** ${d.link}`,
                '',
                '**Telegram draft (HTML):**',
                '```html',
                `${d.message_html}`,
                '```',
                '',
                '---',
                '**Approve:** add label `approve`',
                '**Reject:** add label `reject`',
                '',
                `(id: ${d.id})`
              ];

              await github.rest.issues.create({
                owner,
                repo,
                title,
                body: bodyLines.join('\\n'),
                labels: ['pending']
              });
            }

      - name: Commit updated state (seen/reviewed)
        run: |
          git config user.name "fintech-news-bot"
          git config user.email "fintech-news-bot@users.noreply.github.com"

          if [ -f state/seen_alerts.json ]; then
            git add state/seen_alerts.json
          fi

          git diff --cached --quiet && echo "No state changes" && exit 0
          git commit -m "chore: update alerts state (prepare)"
          git push